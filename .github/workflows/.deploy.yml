name: .Deploys

on:
  workflow_call:
    inputs:
      ### Required
      # Nothing! Only `secrets: inherit` is required

      ### Typical / recommended
      environment:
        description: GitHub/OpenShift environment; usually PR number, test or prod
        default: ''
        required: false
        type: string
      tag:
        description: Container tag; usually PR number
        default: ${{ github.event.number }}
        required: false
        type: string
      target:
        description: Deployment target; usually PR number, test or prod
        default: ${{ github.event.number }}
        required: false
        type: string
      triggers:
        description: Paths to check for changes
        default: ''
        required: false
        type: string
      url:
        description: URL for deployment, does not include path
        default: ''
        required: false
        type: string

permissions: {}

jobs:
  init:
    name: Init
    environment: ${{ inputs.environment }}
    outputs:
      url: ${{ steps.url.outputs.url }}
    runs-on: ubuntu-24.04
    steps:
      - name: Create URL
        id: url
        run: |
          if [ -z "${{ inputs.target }}" ]; then
            echo "url=fom-$(( ${{ inputs.target }} % 50 )).apps.silver.devops.gov.bc.ca" >> $GITHUB_OUTPUT
          else
            echo "url=${{ inputs.url }}" >> $GITHUB_OUTPUT
          fi

      - name: OpenShift Init
        if: steps.triggers.outputs.core == 'true' || steps.triggers.outputs.sync == 'true'
        uses: bcgov-nr/action-deployer-openshift@v3.0.1
        with:
          oc_namespace: ${{ vars.OC_NAMESPACE }}
          oc_server: ${{ vars.OC_SERVER }}
          oc_token: ${{ secrets.OC_TOKEN }}
          file: libs/openshift.init.yml
          overwrite: false
          parameters: -p ZONE=${{ inputs.target }}
          triggers: ${{ inputs.triggers }}

  # deploy:
  #   name: Deploy
  #   needs: [init]
  #   runs-on: ubuntu-24.04
  #   timeout-minutes: 10
  #   strategy:
  #     matrix:
  #       name: [api, admin, db, public]
  #       include:
  #         - name: api
  #           file: api/openshift.deploy.yml
  #           overwrite: true
  #           parameters:
  #             -p FOM_EMAIL_NOTIFY=SIBIFSAF@victoria1.gov.bc.ca
  #             -p DB_TESTDATA=true
  #             -p AWS_USER_POOLS_WEB_CLIENT_ID="7hpo4qa7j0hs0rkfl2pm0sto5k"
  #             -p LOGOUT_CHAIN_URL="https://logontest7.gov.bc.ca/clp-cgi/logoff.cgi?retnow=1&returl=https://dev.loginproxy.gov.bc.ca/auth/realms/standard/protocol/openid-connect/logout?redirect_uri="
  #         - name: admin
  #           file: admin/openshift.deploy.yml
  #           overwrite: true
  #         - name: db
  #           file: db/openshift.deploy.yml
  #           overwrite: false
  #         - name: public
  #           file: public/openshift.deploy.yml
  #           overwrite: true
  #   steps:
  #     - uses: bcgov-nr/action-deployer-openshift@v3.0.1
  #       with:
  #         file: ${{ matrix.file }}
  #         oc_namespace: ${{ vars.OC_NAMESPACE }}
  #         oc_server: ${{ vars.OC_SERVER }}
  #         oc_token: ${{ secrets.OC_TOKEN }}
  #         overwrite: ${{ matrix.overwrite }}
  #         penetration_test: false
  #         parameters:
  #           -p ZONE=${{ github.event.number }} -p TAG=${{ github.event.number }}
  #           -p URL=${{ needs.url.outputs.url }} -p REPLICA_COUNT=1
  #           ${{ matrix.parameters }}
  #         triggers: ${{ inputs.triggers }}
