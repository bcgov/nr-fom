name: Merge to Demo

on:
  push:
    branches:
      - demo

env:
  ZONE: demo

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  builds:
    name: Builds
    runs-on: ubuntu-22.04
    permissions:
      packages: write
    strategy:
      matrix:
        package: [admin, api, db, public]
        include:
          - package: admin
            build_context: ./
            build_file: admin/Dockerfile
            triggers: ('admin/', 'libs/')
          - package: api
            build_context: ./
            build_file: api/Dockerfile
            triggers: ('api/', 'libs/')
          - package: db
            triggers: ('db')
          - package: public
            build_context: ./
            build_file: public/Dockerfile
            triggers: ('public/', 'libs/')
    steps:
      - uses: actions/checkout@v3
      - uses: bcgov-nr/action-builder-ghcr@v1.1.0
        with:
          package: ${{ matrix.package }}
          build_context: ${{ matrix.build_context }}
          build_file: ${{ matrix.build_file }}
          tag: ${{ env.ZONE }}
          tag_fallback: test
          token: ${{ secrets.GITHUB_TOKEN }}
          triggers: ${{ matrix.triggers }}

  deploy:
    name: DEMO Deploys
    needs: [builds]
    environment: test
    env:
      ZONE: demo
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    strategy:
      matrix:
        name: [api, admin, db, init, public]
        include:
          - name: api
            file: api/openshift.deploy.yml
            overwrite: true
            parameters:
              -p URL=fom-demo.apps.silver.devops.gov.bc.ca -p KEYCLOAK_URL="https://test.oidc.gov.bc.ca/auth"
              -p FOM_EMAIL_NOTIFY=FLNR.AdminServicesCariboo@gov.bc.ca
              -p SITEMINDER_URL="https://logontest7.gov.bc.ca" -p DB_TESTDATA=true
          - name: admin
            file: admin/openshift.deploy.yml
            overwrite: true
            parameters: -p URL=fom-demo.apps.silver.devops.gov.bc.ca -p CERTBOT=false
          - name: db
            file: db/openshift.deploy.yml
            overwrite: false
          - name: init
            file: libs/openshift.init.yml
            overwrite: false
          - name: public
            file: public/openshift.deploy.yml
            overwrite: true
            parameters: -p URL=fom-demo.apps.silver.devops.gov.bc.ca -p CERTBOT=false
    steps:
      - uses: bcgov-nr/action-deployer-openshift@v1.0.2
        with:
          file: ${{ matrix.file }}
          oc_namespace: ${{ vars.OC_NAMESPACE }}
          oc_server: ${{ vars.OC_SERVER }}
          oc_token: ${{ secrets.OC_TOKEN }}
          overwrite: ${{ matrix.overwrite }}
          penetration_test: false
          parameters:
            -p PROMOTE=ghcr.io/${{ github.repository }}/${{ matrix.name }}:${{ env.ZONE }}
            -p ZONE=${{ env.ZONE }} ${{ matrix.parameters }}
